# 웹 어플리케이션 이해

## 웹 서버, 웹 어플리케이션 서버

최근에는 대부분의 데이터 통신은 HTTP로 하고 있다.

`웹 서버`란 HTTP 기반으로 동작하며 정적 리소스를 제공한다. nginx 같은것이 존재한다.

`웹 어플리케이션(WAS)` 는 HTTP 기반으로 동작하며, 웹 서버 기능을 포함한 정적 리소스도 제공 가능하다.

### 웹 서버, 웹 어플리케이션 서버 차이

- **웹 서버는 정적 리소스, WAS는 어플리케이션 로직**
- 자바는 서블릿 컨테이너 기능을 제공하면 WAS
- WAS는 어플리케이션 코드를 실행하는데 더 특화

### 웹 시스템 구성

- 클라이언트 → 웹 서버 → WAS → DB 와 같은 구성을 한다.
- WAS에서 정적 리소스를 처리하기에는 하는 일이 너무 많이 때문에 웹 서버를 통해 정적 리소스를 담당
- 동적인 처리는 WAS에 요청 위임
- 위와 같은 구성을 통해 효율적인 리소스 관리 가능
  - 정적 리소스 또는 동적 리소스 필요에 따라 원하는 서버를 증축하면 된다.

## 서블릿

- URL 을 호출 하면 해당하는 서블릿 코드가 실행
- 서블릿을 사용하면 개발자는 HTTP 스펙을 매우 편리하게 사용할 수 있도록 지원
- HTTP 요청 정보를 편리하게 사용할 수 있도록 `HtppServletRequest` 제공
- HTTP 응답 정보를 편리하게 제공할 수 있도록 `HtppServletResponse` 제공

### 요청 후 하는일

1. HTTP 요청
2. 요청 메시지를 기반으로 Request 생성
3. 서블릿 실행
4. 개발자는 서블릿에서 제공하는 Response 객체를 사용해서 편리하게 응답 객체 생성
5. 응답객체를 기반으로 Http 응답 메시지 생성 후 브라우저로 전달

### 서블릿 컨테이너

- **톰캣** 처럼 서블릿을 지원하는 WAS를 `서블릿 컨테이너`
- 서블릿 컨테이너는 서블릿 객체를 생성, 초기화, 호출, 종료하는 **생명주기 관리**
- 서블릿 객체는 **싱글톤**
  - 최초 로딩 시 미리 만들고 재활용
  - 싱글톤이기 때문에 **공유 변수** 사용시 **주의**
- JSP도 서블릿으로 변환되어서 사용
- 동시 요청을 위한 **멀티 쓰레드 처리 지원**

## 동시 요청 - 멀티 쓰레드

### 쓰레드

- 어플리케이션 코드를 순차적으로 실행하는 것
- 자바 메인 메서드 실행 시 main 이라는 쓰레드 실행
- 쓰레드 없으면 자바 어플리케이션 실행 불가
- 쓰레드는 한번에 하나의 코드 라인만 수행
- 동시 처리가 필요 시 쓰레드를 추가로 생성

### 단일 쓰레드 사용

단일 쓰레드를 사용하면 다중 요청이 들어온 경우 하나의 요청이 진행 중이라면 다른 요청은 끝날때까지 기다려야 한다. 그러다 지연이 오래되면 타임오버되어 **응답이 중지**되어버린다.

### 요청마다 쓰레드 생성하는 경우

- 장점
  - 동시 요청 처리 가능
  - 리소스 허용까지 처리 가능
  - 다른 쓰레드가 지연되어도 나머지 요청은 정상 동작 가능
- 단점
  - 쓰레드는 생성비용이 매우 비싸다(생성 시 오래걸린다는 것)
    - 요청때마다 쓰레드 생성하면 응답속도가 늦어진다.
  - 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
  - 고객 요청이 너무 많이 오면 CPU, 메모리 임계점 넘어 서버가 죽는다.

### 쓰레드 풀

- 요청이 오면 쓰레드 풀에 쓰레드를 요청
- 쓰레드 풀에 해당하는 만큼만 쓰레드 사용
- 미리 정의한 쓰레드 수만큼 쓰레드 풀에서 생성 후 요청하면 쓰레드 전달
- 사용 완료하면 쓰레드 풀에 반납
- 쓰레드 풀이 비어있으면 요청은 **대기** 또는 **거절**
- 톰캣은 기본으로 최대 200개
- 장점 :
  - 쓰레드를 미리 생성하여 **응답시간이 빠르다**
  - 무한정으로 쓰레드가 늘어나지 않기 때문에 요청이 많이 와도 기존 요청은 **안전하게 처리 가능**
    - 쓰레드 계속 생성하는 방식은 임계점 넘어 서버가 죽는데 이건 죽진 않는다.

### 쓰레드 풀 실무 팁

- WAS의 튜닝 포인트는 `최대 쓰레드 수` 이다.
- 너무 **낮으면**
  - 요청 많을 시 클라이언트 **응답 지연** 발생
- 너무 **높으면**
  - 동시 요청 많으면 CPU, 메모리 임계점 초과로 **서버 다운**
- 장애 발생시
  - 클라우드면 일단 **서버 늘린 후 이후 튜닝**
  - 클라우드가 아니면 **열심히 튜닝 ㅠ**

### 쓰레드 풀의 적정 숫자

- 어플리케이션의 로직의 복잡도, CPU, 메모리, IO 리소스 상황에 따라 다른것
- 성능 테스트
  - 실 서비스와 유사하게 성능 테스트를 시도해서 적정 숫자 찾기
  - 툴 : 아파치 ab, 제이미터, nGrinder

<aside>
💡 **멀티 쓰레드** 관련된 건 **`WAS`**가 처리

</aside>

## HTML, HTTP API, CSR, SSR

### 정적 리소스

- HTML, CSS, JS, 이미지

### HTML 페이지

- WAS에서 동적으로 처리 된 결과를 HTML 로 만들어진다.
- JSP, 서블릿 등에서 처리 된 결과가 HTML로 만들어진다.

### HTTP API

- HTML이 아닌 데이터를 전달
- JSON 형식을 주로 사용
- (앱, 웹 클라이언트, 서버) to 서버 등 다양하게 사용

### SSR

- 동적으로 HTML 최종 결과를 생성 후 전달
- JSP

### CSR

- HTML 결과를 자바스크립트로 동적으로 생성
- 화면의 일부를 동적으로 변경가능
- HTTP API를 주로 사용
- React, Vue
